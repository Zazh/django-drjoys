{% extends 'base.html' %}
{% load static %}

{% block title %}Home{% endblock %}

{% block content %}
<main class="mt-[7.5rem] lg:mt-[7.5rem]">
<section class="main-grid">
    <div class="col-span-full">
        <div class="mb-6">
            <h1 class="[ br-lg ] display-1 text-center pb-5"><span>Ультратонкие</span> <span>презервативы </span><span>DR.JOYS</span></h1>
            <h2 class="flex flex-wrap justify-center text-sm lg:text-xl font-medium leading-tight">
                <span class="flex justify-center gap-1 w-full">Неощутимые на 95% <span class="lg:text-sm text-xs mb-auto">(0,02 мм)</span></span>
                <span class="flex justify-center w-full">Тоньше волоса, прочнее стали</span>
            </h2>
        </div>
    </div>
</section>

<section>
    <div class="col-span-full">
        <div class="hero-carousel-container gap-2 lg:gap-0 flex justify-center items-center relative pb-6 pt-12 h-[23rem] max-lg:px-[30%] max-lg:justify-start">
            <!-- Card 1 -->
            <div class="w-[240px]">
                <div class="hero-carousel-card bg-white" data-parallax>
                    <!-- background -->
                    <div class="hero-carousel-card_layer [ rotate-[4deg] ] [ flex items-center justify-center ]" data-depth="0.2">
                        <div class="hero-carousel-card_bg [ bg-gradient-to-b from-[#ACE143] to-[#D7E422] ]">
                            <img src="{% static 'dist/images/hero/prod_bg/gl.svg' %}" data-depth="0.4" alt="" class="absolute -top-[1rem] -left-[1rem]">
                            <img src="{% static 'dist/images/hero/prod_bg/gr.svg' %}" data-depth="-0.4" alt="" class="absolute -top-[1rem] -right-[1rem]">
                        </div>
                    </div>

                    <!-- Product image -->
                    <div class="hero-carousel-card_layer [ flex justify-center ]" data-depth="-0.2">
                        <div class="w-[80%] relative">
                            <img src="{% static 'dist/images/hero/1.png' %}" class="absolute bottom-10 hero-carousel-card-product_img">
                        </div>
                    </div>

                    <!-- Count -->
                    <div class="hero-carousel-card_layer [ flex justify-end ]" data-depth="1.5">
                        <div class="w-[45%] relative">
                            <img src="{% static 'dist/images/hero/counter/5.svg' %}" class="w-full absolute bottom-8 -right-[1.5rem] ">
                        </div>
                    </div>

                    <!-- Light spark -->
                    <div class="hero-carousel-card_layer [ flex justify-center items-center ]" data-depth="0.5">
                        <div class="w-full relative z-50">
                            <img src="{% static 'dist/images/hero/light.svg' %}" class="">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card 2 -->
            <div class="w-[240px]">
                <div class="hero-carousel-card bg-white [ active ]" data-parallax>
                    <!-- background -->
                    <div class="hero-carousel-card_layer [ rotate-[1deg] ] [ flex items-center justify-center ]" data-depth="0.2">
                        <div class="hero-carousel-card_bg [ bg-gradient-to-b from-[#FE70BA] to-[#F3971C] ]">
                            <svg data-depth="0.4" class="absolute -bottom-[4.5rem] -right-[2rem] w-[17rem]" viewBox="0 0 337 395" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M297.668 94.9485C230.919 49.738 140.159 67.1977 94.9482 133.946C49.7377 200.694 67.1975 291.455 133.946 336.666L94.7949 394.467C-3.87654 327.634 -29.6867 193.467 37.1463 94.7951C103.979 -3.87626 238.147 -29.6864 336.819 37.1466L297.668 94.9485Z" fill="url(#paint0_linear_2029_83)"/>
                                <defs>
                                    <linearGradient id="paint0_linear_2029_83" x1="247.488" y1="-23.3593" x2="5.46467" y2="333.961" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#F42296"/>
                                        <stop offset="1" stop-color="#FDFF7E"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                        </div>
                    </div>

                    <!-- Product image -->
                    <div class="hero-carousel-card_layer [ flex justify-center ]" data-depth="-0.2">
                        <div class="w-[70%] relative product-image">
                            <img src="{% static 'dist/images/hero/2.png' %}" class="absolute bottom-10 hero-carousel-card-product_img">
                        </div>
                    </div>

                    <!-- Count -->
                    <div class="hero-carousel-card_layer [ flex justify-end ]" data-depth="1.5">
                        <div class="w-[60%] relative">
                            <img src="{% static 'dist/images/hero/counter/17.svg' %}" class="w-full absolute bottom-8 -right-[1.5rem]">
                        </div>
                    </div>

                    <!-- Light spark -->
                    <div class="hero-carousel-card_layer [ flex justify-center items-center ]" data-depth="0.5">
                        <div class="w-full relative z-50">
                            <img src="{% static 'dist/images/hero/light.svg' %}" class="">
                        </div>
                    </div>

                    <!-- Bundle -->
                    <div class="hero-carousel-card_layer [ flex justify-start items-center ]"  data-depth="-0.5">
                        <div class="inset-0 w-full aspect-square relative">
                            <img src="{% static 'dist/images/hero/top.svg' %}" class="absolute top-0 -left-[1.5rem]">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card 3 -->
            <div class="w-[240px]">
                <div class="hero-carousel-card bg-white " data-parallax>
                    <!-- background -->
                    <div class="hero-carousel-card_layer [ -rotate-[4deg] ] [ flex items-center justify-center ]" data-depth="0.2">
                        <div class="hero-carousel-card_bg [ bg-gradient-to-b from-[#AF87DF] to-[#5C40AE] ]" data-depth="-0.2">
                            <img src="{% static 'dist/images/hero/prod_bg/ic.svg' %}" data-depth="0.4" alt="" class="w-[17rem] absolute bottom-0 -left-[1rem]">
                        </div>
                    </div>

                    <!-- Product image -->
                    <div class="hero-carousel-card_layer [ flex justify-center ]" data-depth="-0.2">
                        <div class="w-[80%] relative">
                            <img src="{% static 'dist/images/hero/3.png' %}" class="absolute bottom-10 hero-carousel-card-product_img">
                        </div>
                    </div>

                    <!-- Count -->
                    <div class="hero-carousel-card_layer [ flex justify-end ]" data-depth="1.5">
                        <div class="w-[50%] relative">
                            <img src="{% static 'dist/images/hero/counter/30.svg' %}" class="w-full absolute bottom-10 -right-[1.5rem]">
                        </div>
                    </div>

                    <!-- Light spark -->
                    <div class="hero-carousel-card_layer [ flex justify-center items-center ]">
                        <div class="w-full relative z-50">
                            <img src="{% static 'dist/images/hero/light.svg' %}" class="">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="main-grid">
    <div class="col-span-full">
        <div class="flex justify-center items-center gap-2 pb-10">
            <button class="btn-macro default">В каталог</button>
            <button class="btn-macro danger">Купить</button>
        </div>
    </div>
</section>

<!-- Presentation block -->
<section id="features" class="features ">
    <div class="features-carousel">
        <div class="features-cursor"></div>
        <div class="features-card">
            <div class="features-card-container">
                <div>
                    <h1 class="display-2">1 Тоньше волоса</h1>
                </div>
                <div class="features-card-content">
                    <p>Толщина человеческого волоса и «ультратонких» презервативов других брендов - 0,05 мм. DR.JOYS имеют толщину всего 0,02 мм, что делает их на 95% неощутимыми.</p>
                    <p>Только такая толщина позволяет сохранять живое тепло партнера и чувствовать каждое сокращение мышц.</p>
                </div>
            </div>
            <div class="absolute inset-0 z-0">
                <img class="features-bg-img" src="{% static 'dist/images/features/1.jpg' %}" alt="">
            </div>
        </div>
        <div class="features-card">
            <div class="features-card-container">
                <div>
                    <h1 class="display-2">2 Тоньше волоса</h1>
                </div>
                <div class="features-card-content">
                    <p>Толщина человеческого волоса и «ультратонких» презервативов других брендов - 0,05 мм. DR.JOYS имеют толщину всего 0,02 мм, что делает их на 95% неощутимыми.</p>
                    <p>Только такая толщина позволяет сохранять живое тепло партнера и чувствовать каждое сокращение мышц.</p>
                </div>
            </div>
            <div class="absolute inset-0 z-0">
                <img class="features-bg-img" src="{% static 'dist/images/features/1.jpg' %}" alt="">
            </div>
        </div>
        <div class="features-card">
            <div class="features-card-container">
                <div>
                    <h1 class="display-2">3 Тоньше волоса</h1>
                </div>
                <div class="features-card-content">
                    <p>Толщина человеческого волоса и «ультратонких» презервативов других брендов - 0,05 мм. DR.JOYS имеют толщину всего 0,02 мм, что делает их на 95% неощутимыми.</p>
                    <p>Только такая толщина позволяет сохранять живое тепло партнера и чувствовать каждое сокращение мышц.</p>
                </div>
            </div>
            <div class="absolute inset-0 z-0">
                <img class="features-bg-img" src="{% static 'dist/images/features/1.jpg' %}" alt="">
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="absolute bottom-14 flex justify-center items-center w-full">
        <div class="features-controls">
            <div class="features-dots">
                <button class="features-dot active" data-index="0"></button>
                <button class="features-dot" data-index="1"></button>
                <button class="features-dot" data-index="2"></button>
            </div>
            <button class="features-pause">
                <svg class="pause-icon" width="14" height="16" viewBox="0 0 14 16" fill="none">
                    <rect width="4" height="16" rx="1" fill="white"/>
                    <rect x="10" width="4" height="16" rx="1" fill="white"/>
                </svg>
                <svg class="play-icon hidden" width="14" height="16" viewBox="0 0 14 16" fill="none">
                    <path d="M14 8L0 16V0L14 8Z" fill="white"/>
                </svg>
            </button>
        </div>
    </div>
</section>


<!-- Quizzes block -->
<section id="quizzes" class="quizzes">
    <div class="quizzes-container">

    </div>
</section>

</main>

{% block scripts %}
<!-- GSAP -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>

<script>
    // --------------------------------------------
    // PARALLAX ЭФФЕКТ
    // --------------------------------------------
    document.addEventListener('DOMContentLoaded', () => {
        const containers = document.querySelectorAll('[data-parallax]');
        const isMobile = window.innerWidth < 1024;

        containers.forEach(container => {
            const layers = container.querySelectorAll('[data-depth]');

            // Desktop: mousemove
            if (!isMobile) {
                container.addEventListener('mousemove', (e) => {
                    const rect = container.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;

                    const x = (e.clientX - centerX) / (rect.width / 2);
                    const y = (e.clientY - centerY) / (rect.height / 2);

                    layers.forEach(layer => {
                        const depth = parseFloat(layer.dataset.depth);
                        const moveX = x * 15 * depth;
                        const moveY = y * 15 * depth;

                        gsap.to(layer, {
                            x: moveX,
                            y: moveY,
                            duration: 0.3,
                            ease: 'power2.out'
                        });
                    });
                });

                container.addEventListener('mouseleave', () => {
                    layers.forEach(layer => {
                        gsap.to(layer, {
                            x: 0,
                            y: 0,
                            duration: 0.5,
                            ease: 'power2.out'
                        });
                    });
                });
            }
        });

        // Mobile: scroll parallax
        if (isMobile) {
            const allLayers = document.querySelectorAll('[data-parallax] [data-depth]');

            const updateScrollParallax = () => {
                allLayers.forEach(layer => {
                    const rect = layer.closest('[data-parallax]').getBoundingClientRect();
                    const depth = parseFloat(layer.dataset.depth);

                    // Позиция контейнера относительно центра экрана
                    const centerOffset = (rect.top + rect.height / 2 - window.innerHeight / 2) / window.innerHeight;

                    const moveY = centerOffset * 30 * depth;

                    gsap.to(layer, {
                        y: moveY,
                        duration: 0.1,
                        ease: 'none'
                    });
                });
            };

            window.addEventListener('scroll', updateScrollParallax, { passive: true });
            updateScrollParallax(); // Инициализация
        }
    });
</script>

<script>
    // --------------------------------------------
    // HERO CARD CAROUSEL SLIDER
    // --------------------------------------------
    document.addEventListener('DOMContentLoaded', () => {
        const container = document.querySelector('.hero-carousel-container');
        const cards = document.querySelectorAll('.hero-carousel-card');

        if (window.innerWidth >= 1024) return; // Только mobile

        const updateActiveCard = () => {
            const containerRect = container.getBoundingClientRect();
            const containerCenter = containerRect.left + containerRect.width / 2;

            let closestCard = null;
            let closestDistance = Infinity;

            cards.forEach(card => {
                const cardRect = card.getBoundingClientRect();
                const cardCenter = cardRect.left + cardRect.width / 2;
                const distance = Math.abs(containerCenter - cardCenter);

                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestCard = card;
                }
            });

            cards.forEach(card => card.classList.remove('active'));
            if (closestCard) closestCard.classList.add('active');
        };

        // Прокрутка ко второй карточке при загрузке
        const scrollToCenter = () => {
            const centerCard = cards[1]; // Вторая карточка
            if (centerCard) {
                const wrapper = centerCard.closest('.hero-carousel-container > div');
                const scrollLeft = wrapper.offsetLeft - (container.offsetWidth - wrapper.offsetWidth) / 2;
                container.scrollLeft = scrollLeft;
            }
        };

        scrollToCenter();
        container.addEventListener('scroll', updateActiveCard);
        updateActiveCard();
    });
</script>


<script>
    // --------------------------------------------
    // FEATURES CAROUSEL
    // --------------------------------------------
    document.addEventListener('DOMContentLoaded', () => {
        const section = document.querySelector('#features');
        const carousel = document.querySelector('.features-carousel');
        const cursor = document.querySelector('.features-cursor');
        const dots = document.querySelectorAll('.features-dot');
        const pauseBtn = document.querySelector('.features-pause');
        const pauseIcon = pauseBtn?.querySelector('.pause-icon');
        const playIcon = pauseBtn?.querySelector('.play-icon');

        if (!carousel || !section) return;

        const cards = carousel.querySelectorAll('.features-card');
        let currentIndex = 0;
        let isPlaying = true;
        let isVisible = false;
        let autoplayInterval;
        let isDragging = false;

        // Scroll to card
        const scrollToCard = (index) => {
            const card = cards[index];
            if (!card) return;

            const isMobile = window.innerWidth < 1024;
            const scrollLeft = isMobile
                ? card.offsetLeft - 20
                : card.offsetLeft - (carousel.offsetWidth - card.offsetWidth) / 2;

            carousel.scrollTo({ left: scrollLeft, behavior: 'smooth' });
        };

        // Update dots
        const updateDots = (index) => {
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });
            currentIndex = index;
        };

        // Autoplay
        const startAutoplay = () => {
            if (autoplayInterval) clearInterval(autoplayInterval);
            if (!isPlaying || !isVisible) return;

            autoplayInterval = setInterval(() => {
                if (!isDragging && isPlaying && isVisible) {
                    const nextIndex = (currentIndex + 1) % cards.length;
                    scrollToCard(nextIndex);
                    updateDots(nextIndex);
                }
            }, 4000);
        };

        const stopAutoplay = () => {
            clearInterval(autoplayInterval);
        };

        // Intersection Observer
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                isVisible = entry.isIntersecting;

                if (isVisible && isPlaying) {
                    startAutoplay();
                } else {
                    stopAutoplay();
                }
            });
        }, {
            threshold: 0.3 // 30% видимости
        });

        observer.observe(section);

        // Detect current card on scroll
        const onScroll = () => {
            const scrollLeft = carousel.scrollLeft;
            let closestIndex = 0;
            let closestDistance = Infinity;

            cards.forEach((card, i) => {
                const distance = Math.abs(card.offsetLeft - scrollLeft - 20);
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestIndex = i;
                }
            });

            if (closestIndex !== currentIndex) {
                updateDots(closestIndex);
            }
        };

        carousel.addEventListener('scroll', onScroll);

        // Dot click
        dots.forEach((dot, i) => {
            dot.addEventListener('click', () => {
                scrollToCard(i);
                updateDots(i);
                if (isPlaying && isVisible) startAutoplay();
            });
        });

        // Pause/Play
        pauseBtn?.addEventListener('click', () => {
            isPlaying = !isPlaying;
            pauseIcon.classList.toggle('hidden', !isPlaying);
            playIcon.classList.toggle('hidden', isPlaying);

            if (isPlaying && isVisible) {
                startAutoplay();
            } else {
                stopAutoplay();
            }
        });

        // Desktop cursor + drag
        if (cursor && window.innerWidth >= 1024) {
            let startX;
            let scrollLeft;

            carousel.addEventListener('mouseenter', () => {
                cursor.classList.add('visible');
            });

            carousel.addEventListener('mouseleave', () => {
                cursor.classList.remove('visible', 'dragging');
                isDragging = false;
            });

            carousel.addEventListener('mousemove', (e) => {
                cursor.style.left = e.clientX + 'px';
                cursor.style.top = e.clientY + 'px';

                if (!isDragging) return;
                e.preventDefault();
                const x = e.pageX - carousel.offsetLeft;
                const walk = (x - startX) * 1.5;
                carousel.scrollLeft = scrollLeft - walk;
            });

            carousel.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.pageX - carousel.offsetLeft;
                scrollLeft = carousel.scrollLeft;
                cursor.classList.add('dragging');
            });

            carousel.addEventListener('mouseup', () => {
                isDragging = false;
                cursor.classList.remove('dragging');
            });
        }
    });
</script>
{% endblock %}

{% endblock %}
